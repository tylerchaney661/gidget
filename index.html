<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gidget · Hamster Tracker</title>
<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#0B0F14" />
<meta name="x-gidget-version" content="2025-08-23-11" />

<style>
  :root{
    --bg:#0B0F14; --card:#0F141A; --line:#1D2A36; --fg:#E9EEF5; --muted:#9FB0C2;
    --acc:#6EE7B7; --acc-ink:#06291F;
    --radius:14px; --shadow:0 12px 34px rgba(0,0,0,.35); --ring:0 0 0 2px rgba(110,231,183,.35);
    --blur:8px; --ease:cubic-bezier(.2,.65,.2,1);
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#F6F8FB; --card:#FFFFFF; --line:#E6ECF2; --fg:#0F1720; --muted:#516072; --acc:#0EA5E9; --acc-ink:#00131C; --shadow:0 12px 34px rgba(0,0,0,.08); --ring:0 0 0 2px rgba(14,165,233,.25);}
  }

  *{box-sizing:border-box}
  html{scroll-behavior:smooth; height:100%}
  body{
    margin:0; min-height:100%; color:var(--fg);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    background:
      radial-gradient(1200px 800px at 80% -200px, color-mix(in oklab, var(--acc) 20%, transparent), transparent),
      radial-gradient(800px 600px at -10% -100px, rgba(255,255,255,.05), transparent),
      var(--bg);
  }

  /* Header (sticky + shrink) */
  header{
    position:sticky; top:0; z-index:1000;
    backdrop-filter:blur(var(--blur));
    background:color-mix(in oklab, var(--bg) 86%, transparent);
    border-bottom:1px solid var(--line);
    transition:background .28s var(--ease), backdrop-filter .28s var(--ease);
    will-change:backdrop-filter,background;
  }
  .nav{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;transition:padding .22s var(--ease)}
  header.shrink .nav{padding:6px 16px}
  .brand{display:flex;gap:10px;align-items:center}
  .badge{width:30px;height:30px;border-radius:10px;background:linear-gradient(145deg,color-mix(in oklab,var(--acc) 90%,white),var(--acc));display:grid;place-items:center;color:var(--acc-ink);font-weight:900;box-shadow:inset 0 0 0 1px rgba(255,255,255,.25),0 8px 18px rgba(0,0,0,.25);transition:all .22s var(--ease)}
  header.shrink .badge{width:24px;height:24px}
  .title{font-weight:800;transition:transform .22s var(--ease),opacity .22s var(--ease)}
  header.shrink .title{transform:translateY(-1px) scale(.98);opacity:.95}
  .muted{color:var(--muted)}

  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:var(--acc);color:var(--acc-ink);font-weight:700;cursor:pointer;box-shadow:var(--shadow);transition:transform .16s var(--ease),box-shadow .16s var(--ease)}
  .btn.small{padding:8px 10px;font-size:12px}
  .btn.secondary{background:transparent;color:var(--fg);border:1px solid var(--line);box-shadow:none}
  .btn:active{transform:translateY(1px) scale(.99)}

  main{max-width:1100px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:1.4fr .9fr;gap:16px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}

  .card{background:linear-gradient(180deg,color-mix(in oklab,var(--card) 94%,black),var(--card));border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
  label{display:block;font-size:13px;color:var(--muted);margin:8px 0 6px}
  input,select,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:var(--bg);color:var(--fg);transition:border-color .2s,box-shadow .2s}
  input:focus,select:focus,textarea:focus{outline:none;box-shadow:var(--ring);border-color:transparent}
  textarea{min-height:90px;resize:vertical}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1;min-width:220px}

  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;cursor:pointer;color:var(--muted);user-select:none}
  .tab.active{background:var(--acc);color:var(--acc-ink);border-color:transparent;font-weight:800}

  table{width:100%;border-collapse:collapse;margin-top:8px;border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
  tr:hover td{background:color-mix(in oklab,var(--bg) 92%,var(--acc) 8%)}

  canvas{width:100%;height:260px;border:1px solid var(--line);border-radius:12px;background:var(--bg)}
  @media(max-width:700px){canvas{height:340px} table{display:block;overflow-x:auto;white-space:nowrap} th,td{min-width:120px}}

  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cal-head{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:6px;color:var(--muted);font-size:12px}
  .cell{min-height:84px;border:1px solid var(--line);border-radius:12px;padding:8px;cursor:pointer;transition:transform .15s,border-color .15s}
  .cell:hover{transform:translateY(-1px);border-color:color-mix(in oklab,var(--acc) 30%,var(--line))}
  .cell .d{font-weight:700;font-size:12px;color:var(--muted)}

  /* Clickable month titles */
  #calTitle,#stepsCalTitle{cursor:pointer;position:relative}
  #calTitle::after,#stepsCalTitle::after{content:"▾";font-size:.9em;margin-left:.35em;opacity:.7}
</style>
</head>
<body>
  <header id="topbar">
    <div class="nav">
      <div class="brand">
        <div class="badge">G</div>
        <div>
          <div class="title">Gidget · Hamster Tracker</div>
          <div class="muted" style="font-size:12px">Wake-up · Steps · Trends · Calendar · Offline</div>
        </div>
      </div>
      <div class="right">
        <button id="exportCsv" class="btn secondary">Export CSV</button>
        <label class="btn secondary" style="padding:10px 12px"><input type="file" id="importCsv" accept=".csv" style="display:none">Import CSV</label>
        <button id="installInfo" class="btn">Install</button>
      </div>
    </div>
  </header>

  <main>
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="log">Log</div>
      <div class="tab" data-tab="trends">Trends</div>
      <div class="tab" data-tab="calendar">Calendar</div>
      <div class="tab" data-tab="entries">Entries</div>
      <div class="tab" data-tab="steps-log">Steps Log</div>
      <div class="tab" data-tab="steps-trends">Steps Trends</div>
      <div class="tab" data-tab="steps-calendar">Steps Calendar</div>
      <div class="tab" data-tab="steps-entries">Steps Entries</div>
    </div>

    <!-- Wake Log -->
    <section class="grid tabpanel" id="panel-log">
      <section class="card">
        <h3>Quick Log (Wake)</h3>
        <div class="row">
          <div class="col"><label for="date">Date</label><input id="date" type="date"></div>
          <div class="col"><label for="wake">Wake‑Up Time</label><div class="row"><input id="wake" type="time" style="flex:1"><button id="nowBtn" class="btn secondary">Now</button></div></div>
        </div>
        <div class="row">
          <div class="col"><label for="weight">Weight (g)</label><input id="weight" type="number" min="0" step="1"></div>
          <div class="col"><label for="mood">Mood</label><select id="mood"><option value="">—</option><option>Calm</option><option>Curious</option><option>Energetic</option><option>Grumpy</option><option>Sleepy</option></select></div>
        </div>
        <label for="notes">Notes</label><textarea id="notes" placeholder="Behaviour, room temp, cage changes…"></textarea>
        <div class="row" style="margin-top:12px"><button id="save" class="btn">Save Entry</button><button id="clearForm" class="btn secondary">Clear</button></div>
        <div class="muted" id="todayBox" style="margin-top:8px">—</div>
        <div class="row" style="margin-top:8px"><span id="streak" class="muted">Streak: 0</span><span id="avg7" class="muted">7‑day avg: —</span></div>
      </section>

      <section class="card">
        <h3>Filter</h3>
        <div class="row">
          <div class="col"><label for="filterFrom">From</label><input id="filterFrom" type="date"></div>
          <div class="col"><label for="filterTo">To</label><input id="filterTo" type="date"></div>
        </div>
        <div class="row" style="margin-top:10px"><button id="applyFilter" class="btn secondary">Apply</button><button id="resetFilter" class="btn secondary">Reset</button></div>
      </section>
    </section>

    <!-- Wake Trends -->
    <section class="card tabpanel" id="panel-trends" hidden>
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="row">
          <button class="btn small secondary rangeBtn" data-range="7">Week</button>
          <button class="btn small secondary rangeBtn" data-range="30">Month</button>
          <button class="btn small secondary rangeBtn" data-range="365">Year</button>
        </div>
        <div class="row">
          <label for="smooth" class="muted" style="margin:0">Smoothing</label>
          <select id="smooth"><option value="1">None</option><option value="3">3‑day</option><option value="7">7‑day</option></select>
        </div>
      </div>
      <canvas id="chart"></canvas>
      <div class="muted" id="chartMeta" style="margin-top:6px">—</div>
    </section>

    <!-- Wake Calendar -->
    <section class="card tabpanel" id="panel-calendar" hidden>
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row"><button id="prevMonth" class="btn small secondary">‹</button><button id="todayMonth" class="btn small secondary">Today</button><button id="nextMonth" class="btn small secondary">›</button></div>
        <div>
          <div class="title" id="calTitle">—</div>
          <div class="muted" style="font-size:12px;margin-top:2px">Tap the month to choose another</div>
        </div>
      </div>
      <div class="cal-head" style="margin-top:8px"><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div></div>
      <div class="calendar" id="calendar"></div>
    </section>

    <!-- Wake Entries -->
    <section class="card tabpanel" id="panel-entries" hidden>
      <h3>Entries</h3>
      <table id="table"><thead><tr><th>Date</th><th>Wake‑Up</th><th>Weight</th><th>Mood</th><th>Food</th><th>Sand</th><th>Notes</th><th></th></tr></thead><tbody></tbody></table>
    </section>

    <!-- Steps Log -->
    <section class="grid tabpanel" id="panel-steps-log" hidden>
      <section class="card">
        <h3>Steps Log (Morning)</h3>
        <div class="row">
          <div class="col"><label for="stepsDate">Date</label><input id="stepsDate" type="date"></div>
          <div class="col"><label for="stepsCount">Steps</label><input id="stepsCount" type="number" min="0" step="1" placeholder="e.g. 12000"></div>
        </div>
        <label for="stepsNotes">Notes</label><textarea id="stepsNotes" placeholder="Morning notes…"></textarea>
        <div class="row" style="margin-top:12px"><button id="stepsSave" class="btn">Save Steps</button><button id="stepsClear" class="btn secondary">Clear</button></div>
        <div class="muted" id="stepsTodayBox" style="margin-top:8px">—</div>
        <div class="row" style="margin-top:8px"><span id="stepsStreak" class="muted">Streak: 0</span><span id="stepsAvg7" class="muted">7‑day avg: —</span></div>
      </section>
    </section>

    <!-- Steps Trends -->
    <section class="card tabpanel" id="panel-steps-trends" hidden>
      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="row">
          <button class="btn small secondary stepsRangeBtn" data-range="7">Week</button>
          <button class="btn small secondary stepsRangeBtn" data-range="30">Month</button>
          <button class="btn small secondary stepsRangeBtn" data-range="365">Year</button>
        </div>
        <div class="row">
          <label for="stepsSmooth" class="muted" style="margin:0">Smoothing</label>
          <select id="stepsSmooth"><option value="1">None</option><option value="3">3‑day</option><option value="7">7‑day</option></select>
        </div>
      </div>
      <canvas id="stepsChart"></canvas>
      <div class="muted" id="stepsChartMeta" style="margin-top:6px">—</div>
    </section>

    <!-- Steps Calendar -->
    <section class="card tabpanel" id="panel-steps-calendar" hidden>
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row"><button id="stepsPrevMonth" class="btn small secondary">‹</button><button id="stepsTodayMonth" class="btn small secondary">Today</button><button id="stepsNextMonth" class="btn small secondary">›</button></div>
        <div>
          <div class="title" id="stepsCalTitle">—</div>
          <div class="muted" style="font-size:12px;margin-top:2px">Tap the month to choose another</div>
        </div>
      </div>
      <div class="cal-head" style="margin-top:8px"><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div></div>
      <div class="calendar" id="stepsCalendar"></div>
    </section>

    <!-- Steps Entries -->
    <section class="card tabpanel" id="panel-steps-entries" hidden>
      <h3>Steps Entries</h3>
      <table id="stepsTable"><thead><tr><th>Date</th><th>Steps</th><th>Notes</th><th></th></tr></thead><tbody></tbody></table>
    </section>

    <div id="ver" class="muted" style="text-align:center;margin-top:14px">Version 2025-08-23-11 • SW ?v=16 • add “?nosw=1” to bypass</div>
  </main>

  <div class="toast" id="toast" style="position:fixed;left:16px;right:16px;bottom:16px;display:none;z-index:1100">
    <div class="card" id="toastText">Saved</div>
  </div>

  <!-- Hidden native month pickers -->
  <input type="month" id="monthPicker" style="position:fixed;left:-9999px;top:-9999px;opacity:0;pointer-events:none" />
  <input type="month" id="stepsMonthPicker" style="position:fixed;left:-9999px;top:-9999px;opacity:0;pointer-events:none" />

  <!-- Modal -->
  <div id="modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);z-index:1200">
    <div id="modalCard" class="card" style="max-width:520px;width:92%">
      <div id="modalTitle" class="title" style="margin-bottom:8px">Details</div>
      <div id="modalBody" class="muted">—</div>
      <div class="row" style="margin-top:14px;justify-content:flex-end">
        <button id="modalDelete" class="btn secondary">Delete</button>
        <button id="modalEdit" class="btn">Edit</button>
        <button id="modalClose" class="btn secondary">Close</button>
      </div>
    </div>
  </div>

<script>
/* ---------- helpers ---------- */
const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>[...r.querySelectorAll(s)];
function ymdLocal(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${day}`;}
function toMin(t){if(!t) return null; const [H,M]=t.split(':').map(Number); return H*60+M}
function fromMin(m){const H=String(Math.floor(m/60)).padStart(2,'0'); const M=String(m%60).padStart(2,'0'); return `${H}:${M}`}
function toast(msg){$('#toastText').textContent=msg; const t=$('#toast'); t.style.display='block'; setTimeout(()=>t.style.display='none',1400)}
function setupCanvas(canvas,baseCssHeight=260){const cssH=(innerWidth<=700)?340:baseCssHeight; canvas.style.width='100%'; canvas.style.height=cssH+'px'; const dpr=devicePixelRatio||1; const rect=canvas.getBoundingClientRect(); canvas.width=Math.max(1,Math.round(rect.width*dpr)); canvas.height=Math.max(1,Math.round(cssH*dpr)); return {W:rect.width,H:cssH,dpr};}

/* ---------- theme (kept minimal) ---------- */
const THEME_MODE_KEY='gidget.theme.mode', THEME_ACCENT_KEY='gidget.theme.accent', ACCENTS={mint:'#6EE7B7',blue:'#0EA5E9',violet:'#8b5cf6',amber:'#f59e0b',rose:'#f43f5e'};
function applyTheme(mode,accent){const root=document.documentElement; if(mode==='light'||mode==='dark') root.setAttribute('data-mode',mode); else root.removeAttribute('data-mode'); root.style.setProperty('--acc', ACCENTS[accent]||ACCENTS.mint);}
function initTheme(){const m=localStorage.getItem(THEME_MODE_KEY)||'system', a=localStorage.getItem(THEME_ACCENT_KEY)||'mint'; applyTheme(m,a);}

/* ---------- storage ---------- */
const KEY='gidget_site_v1', STEPS_KEY='gidget_steps_v1';
const load = () => {try{return JSON.parse(localStorage.getItem(KEY))||[]}catch{return[]}}
const save = (rows) => localStorage.setItem(KEY, JSON.stringify(rows));
const loadSteps = () => {try{return JSON.parse(localStorage.getItem(STEPS_KEY))||[]}catch{return[]}}
const saveSteps = (rows) => localStorage.setItem(STEPS_KEY, JSON.stringify(rows));

/* ---------- tabs (event delegation) ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  initTheme();
  const tabs = $('#tabs');
  tabs.addEventListener('click', (ev)=>{
    const t = ev.target.closest('.tab'); if(!t) return;
    $$('.tab',tabs).forEach(el=>el.classList.remove('active')); t.classList.add('active');
    $$('.tabpanel').forEach(p=>p.hidden=true);
    const panel = $('#panel-'+t.dataset.tab); if(panel){panel.hidden=false;}
    if(t.dataset.tab==='trends') drawChart();
    if(t.dataset.tab==='calendar') renderCalendar();
    if(t.dataset.tab==='entries') renderTable(load());
    if(t.dataset.tab==='steps-trends') drawStepsChart();
    if(t.dataset.tab==='steps-calendar') renderStepsCalendar();
    if(t.dataset.tab==='steps-entries') renderStepsTable(loadSteps());
  });

  boot();
});

/* ---------- header shrink (robust) ---------- */
(function headerShrink(){
  const hdr=$('#topbar'); if(!hdr) return;
  let ticking=false;
  function onScroll(){ if(ticking) return; ticking=true;
    requestAnimationFrame(()=>{ const y=window.scrollY||document.documentElement.scrollTop||0; hdr.classList.toggle('shrink', y>10); ticking=false; });
  }
  window.addEventListener('scroll', onScroll, {passive:true});
  onScroll();
})();

/* ---------- wake form ---------- */
const todayISO=ymdLocal(new Date());
function boot(){
  // default dates
  $('#date').value = todayISO;
  $('#stepsDate').value = todayISO;

  // generic click handlers (single place)
  document.addEventListener('click', (e)=>{
    const id = e.target.id;

    if(id==='nowBtn'){ const n=new Date(); $('#wake').value=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`; }

    if(id==='save'){
      const row={date:$('#date').value||todayISO,wake:$('#wake').value||'',weight:$('#weight').value||'',mood:$('#mood').value||'',notes:$('#notes').value||''};
      const rows=load().filter(r=>r.date!==row.date); rows.push(row); rows.sort((a,b)=>a.date.localeCompare(b.date));
      save(rows); afterWakeChange(rows); toast('Saved');
    }

    if(id==='clearForm'){ $('#date').value=todayISO; $('#wake').value=''; $('#weight').value=''; $('#mood').value=''; $('#notes').value=''; }

    if(id==='applyFilter'){ renderTable(load()) }
    if(id==='resetFilter'){ $('#filterFrom').value=''; $('#filterTo').value=''; renderTable(load()) }

    if(id==='stepsSave'){
      const row={date:$('#stepsDate').value||todayISO, steps: $('#stepsCount').value||'', notes: $('#stepsNotes').value||''};
      const rows=loadSteps().filter(r=>r.date!==row.date); rows.push(row); rows.sort((a,b)=>a.date.localeCompare(b.date));
      saveSteps(rows); afterStepsChange(rows); toast('Steps saved');
    }
    if(id==='stepsClear'){ $('#stepsDate').value=todayISO; $('#stepsCount').value=''; $('#stepsNotes').value=''; }

    // calendar month nav
    if(id==='prevMonth'){ calRef.setMonth(calRef.getMonth()-1); renderCalendar(); }
    if(id==='nextMonth'){ calRef.setMonth(calRef.getMonth()+1); renderCalendar(); }
    if(id==='todayMonth'){ calRef=new Date(); renderCalendar(); }
    if(id==='stepsPrevMonth'){ stepsCalRef.setMonth(stepsCalRef.getMonth()-1); renderStepsCalendar(); }
    if(id==='stepsNextMonth'){ stepsCalRef.setMonth(stepsCalRef.getMonth()+1); renderStepsCalendar(); }
    if(id==='stepsTodayMonth'){ stepsCalRef=new Date(); renderStepsCalendar(); }
  });

  // month title pickers
  setupMonthPicker('#calTitle','#monthPicker',() => calRef, (d)=>{ calRef=d; renderCalendar(); });
  setupMonthPicker('#stepsCalTitle','#stepsMonthPicker',() => stepsCalRef, (d)=>{ stepsCalRef=d; renderStepsCalendar(); });

  // initial render
  afterWakeChange(load());
  afterStepsChange(loadSteps());
}

function afterWakeChange(rows){ renderToday(rows); renderStats(rows); renderTable(rows); drawChart(); renderCalendar(); }
function afterStepsChange(rows){ renderStepsToday(rows); renderStepsStats(rows); renderStepsTable(rows); drawStepsChart(); renderStepsCalendar(); }

function renderToday(rows){ const t=rows.find(r=>r.date===todayISO); $('#todayBox').textContent=t?`Today ${t.date}: wake ${t.wake||'—'} · weight ${t.weight||'—'}g · mood ${t.mood||'—'}`:'No entry for today yet.' }
function renderStats(rows){ let s=0,d=new Date(); while(rows.some(r=>r.date===ymdLocal(d))){s++;d.setDate(d.getDate()-1)} $('#streak').textContent=`Streak: ${s} ${s===1?'day':'days'}`; const cut=new Date(); cut.setDate(cut.getDate()-6); const iso=ymdLocal(cut); const ts=rows.filter(r=>r.date>=iso && r.wake).map(r=>toMin(r.wake)); $('#avg7').textContent=`7‑day avg: ${ts.length?fromMin(Math.round(ts.reduce((a,b)=>a+b,0)/ts.length)):'—'}` }

function renderTable(rows){
  const tb=$('#table tbody'); if(!tb) return; tb.innerHTML='';
  const f1=$('#filterFrom').value||'', f2=$('#filterTo').value||'';
  rows.filter(r=>(!f1||r.date>=f1)&&(!f2||r.date<=f2)).sort((a,b)=>b.date.localeCompare(a.date)).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.date}</td><td>${r.wake||'—'}</td><td>${r.weight||'—'}</td><td>${r.mood||'—'}</td><td>${r.food||'—'}</td><td>${r.sand||'—'}</td><td>${r.notes? r.notes.replace(/</g,'&lt;'):'—'}</td><td><button class="btn small secondary" data-del="${r.date}">Delete</button></td>`;
    tb.appendChild(tr);
  });
  tb.onclick=(e)=>{ const d=e.target.getAttribute?.('data-del'); if(!d) return; const left=load().filter(r=>r.date!==d); save(left); afterWakeChange(left); toast('Entry deleted'); };
}

/* ---------- trends: wake ---------- */
let rangeDays=7, wakePts=[];
document.addEventListener('click', (e)=>{ const b=e.target.closest('.rangeBtn'); if(b){ rangeDays=+b.dataset.range; drawChart(); }});
$('#smooth')?.addEventListener('change', drawChart);

function movingAvg(arr,k){ if(k<=1) return arr.slice(); const out=[]; let sum=0; for(let i=0;i<arr.length;i++){ sum+=arr[i]; if(i>=k) sum-=arr[i-k]; out.push(i>=k-1?sum/Math.min(k,i+1):arr[i]) } return out }

function drawChart(){
  const rows=load().filter(r=>r.wake);
  const canvas=$('#chart'); if(!canvas) return;
  const {W,H,dpr}=setupCanvas(canvas,260);
  const ctx=canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,W,H);
  wakePts=[];

  const now=new Date(), start=new Date(); start.setDate(now.getDate()-rangeDays+1);
  const data=rows.filter(r=>r.date>=ymdLocal(start)).map(r=>({d:r.date,m:toMin(r.wake)})).sort((a,b)=>a.d.localeCompare(b.d));
  $('#chartMeta').textContent=data.length?`${data.length} points`:'No data in range';

  const padL=50, padR=12, padT=12, padB=28;
  const cs=getComputedStyle(document.body); const line=cs.getPropertyValue('--line').trim(), acc=cs.getPropertyValue('--acc').trim(), muted=cs.getPropertyValue('--muted').trim();

  ctx.strokeStyle=line; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(padL,padT); ctx.lineTo(padL,H-padB); ctx.lineTo(W-padR,H-padB); ctx.stroke();

  function yMap(mins){ let v=mins; if(v<900) v+=1440; const min=900, max=1800; const t=(v-min)/(max-min); return padT+(1-t)*(H-padT-padB) }
  ctx.fillStyle=muted; ctx.textAlign='right'; ctx.textBaseline='middle'; ctx.font='12px system-ui';
  [18*60,21*60,0,3*60].forEach(t=>{ const y=yMap(t); ctx.fillText(fromMin((t+1440)%1440), padL-6, y); ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke() });

  if(!data.length) return;

  const xPos=(i)=> padL + (i/(Math.max(1,data.length-1)))*(W-padL-padR);
  function dayLabel(dstr){ const d=new Date(dstr+'T00:00:00'); return (rangeDays<=14)? d.toLocaleDateString(undefined,{weekday:'short',day:'numeric'}) : d.toLocaleDateString(undefined,{day:'2-digit',month:'short'}); }
  function monthLabel(dstr){ const d=new Date(dstr+'T00:00:00'); return d.toLocaleDateString(undefined,{month:'short',year: rangeDays>365?'2-digit':'numeric'}); }

  let ticks=[];
  if(rangeDays<=14){ for(let i=0;i<data.length;i++){ if(i===0||i===data.length-1||i%2===0) ticks.push({i,text:dayLabel(data[i].d)}); } }
  else if(rangeDays<=90){ let last=-1; for(let i=0;i<data.length;i++){ const d=new Date(data[i].d+'T00:00:00'); const nm=d.getMonth()!==last; if(nm||i%5===0||i===data.length-1){ ticks.push({i,text:monthLabel(data[i].d)}); last=d.getMonth(); } } }
  else { let seen={}; for(let i=0;i<data.length;i++){ const d=new Date(data[i].d+'T00:00:00'); const k=`${d.getFullYear()}-${d.getMonth()}`; if(!seen[k]){ seen[k]=true; ticks.push({i,text:d.toLocaleDateString(undefined,{month:'short'})}); } } }

  ctx.fillStyle=muted; ctx.textAlign='center'; ctx.textBaseline='top';
  ticks.forEach(t=>ctx.fillText(t.text, xPos(t.i), H-padB+6));

  ctx.fillStyle=acc;
  data.forEach((pt,i)=>{ const x=xPos(i), y=yMap(pt.m); wakePts.push({x,y,date:pt.d}); ctx.beginPath(); ctx.arc(x,y,2.5,0,Math.PI*2); ctx.fill(); });

  const k=+($('#smooth')?.value||1);
  const vals=data.map(d=>{let v=d.m; if(v<900) v+=1440; return v});
  const sm=movingAvg(vals,k);
  ctx.strokeStyle=acc; ctx.lineWidth=2; ctx.beginPath();
  sm.forEach((v,i)=>{ const x=xPos(i); const y=padT+(1-((v-900)/(1800-900)))*(H-padT-padB); i?ctx.lineTo(x,y):ctx.moveTo(x,y)}); ctx.stroke();
}

(function bindWakeClicks(){
  const canvas=$('#chart'); if(!canvas) return;
  const getXY=(e)=>{const r=canvas.getBoundingClientRect(); const p=e.touches?e.touches[0]:e; return {x:p.clientX-r.left, y:p.clientY-r.top}};
  function openModal(cfg){ const overlay=$('#modal'); const card=$('#modalCard'); $('#modalTitle').textContent=cfg.title; $('#modalBody').innerHTML=cfg.html; overlay.style.display='flex'; $('#modalClose').onclick=closeModal; $('#modalEdit').onclick=()=>{closeModal(); cfg.onEdit?.();}; $('#modalDelete').onclick=()=>{ if(confirm('Delete this entry?')){ cfg.onDelete?.(); closeModal(); } }; overlay.onclick=(e)=>{ if(e.target===overlay) closeModal(); }; }
  function closeModal(){ $('#modal').style.display='none'; }
  const handle=(e)=>{ if(!wakePts.length) return; const {x,y}=getXY(e); let best=null, d2=1e12; for(const p of wakePts){ const dx=x-p.x, dy=y-p.y; const dd=dx*dx+dy*dy; if(dd<d2){d2=dd; best=p;} } if(best && d2<=16*16){ const rows=load(); const r=rows.find(z=>z.date===best.date)||{}; openModal({ title:`Wake • ${best.date}`, html:`<div><b>Wake</b>: ${r.wake||'—'}</div><div><b>Weight</b>: ${r.weight||'—'} g</div><div><b>Mood</b>: ${r.mood||'—'}</div><div style="margin-top:6px"><b>Notes</b>: ${r.notes?String(r.notes).replace(/</g,'&lt;'):'—'}</div>`, onEdit:()=>{ document.querySelector('[data-tab="log"]').click(); $('#date').value=best.date; $('#wake').value=r.wake||''; $('#weight').value=r.weight||''; $('#mood').value=r.mood||''; $('#notes').value=r.notes||''; }, onDelete:()=>{ const left=load().filter(z=>z.date!==best.date); save(left); afterWakeChange(left); toast('Entry deleted'); } }); } };
  canvas.addEventListener('click',handle); canvas.addEventListener('touchstart',handle,{passive:true});
})();

/* ---------- calendar (wake) ---------- */
let calRef=new Date();
function renderCalendar(){
  const rows=load(); const box=$('#calendar'); box.innerHTML='';
  $('#calTitle').textContent=calRef.toLocaleString(undefined,{month:'long',year:'numeric'});
  const y=calRef.getFullYear(), m=calRef.getMonth();
  const first=new Date(y,m,1); const start=new Date(first); const day=(first.getDay()+6)%7; start.setDate(1-day);
  for(let i=0;i<42;i++){
    const d=new Date(start); d.setDate(start.getDate()+i);
    const dISO=ymdLocal(d); const rec=rows.find(r=>r.date===dISO);
    const cell=document.createElement('div'); cell.className='cell'; cell.style.opacity=(d.getMonth()===m)?1:.45;
    cell.innerHTML=`<div class="d">${d.getDate()}</div><div style="margin-top:6px;font-size:13px">${rec?.wake||'—'}</div>`;
    cell.onclick=()=>{ document.querySelector('[data-tab="log"]').click(); $('#date').value=dISO; $('#wake').value=rec?.wake||''; $('#weight').value=rec?.weight||''; $('#mood').value=rec?.mood||''; $('#notes').value=rec?.notes||''; };
    box.appendChild(cell);
  }
}

/* ---------- CSV both ---------- */
$('#exportCsv')?.addEventListener('click', ()=>{
  const rows=load(), steps=loadSteps();
  const header='Type,Date,Wake-Up Time,Weight (g),Mood,Notes,Steps\n';
  const wakeLines=rows.map(r=>['wake',r.date,r.wake||'',r.weight||'',r.mood||'',JSON.stringify(r.notes||'').slice(1,-1),''].join(','));
  const stepLines=steps.map(s=>['steps',s.date,'','','',JSON.stringify(s.notes||'').slice(1,-1),s.steps||''].join(','));
  const blob=new Blob([header+[...wakeLines,...stepLines].join('\n')],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='gidget_data.csv'; a.click();
});
$('#importCsv')?.addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return; const text=await f.text();
  const lines=text.trim().split(/\r?\n/); const header=lines.shift()?.split(',')||[]; const typeIdx=header.indexOf('Type');
  const outWake=[], outSteps=[];
  for(const ln of lines){ const p=ln.split(','); const type=(typeIdx>=0?p[typeIdx]:'wake'); if(type==='steps'){ outSteps.push({date:p[1],steps:p[6]||'',notes:p[5]||''}); } else { outWake.push({date:p[1],wake:p[2]||'',weight:p[3]||'',mood:p[4]||'',notes:p[5]||''}); } }
  save(outWake); saveSteps(outSteps); afterWakeChange(outWake); afterStepsChange(outSteps); toast('Imported CSV');
});

/* ---------- Steps ---------- */
function renderStepsToday(rows){ const t=rows.find(r=>r.date===todayISO); $('#stepsTodayBox').textContent=t?`This morning ${t.date}: ${t.steps||'—'} steps`:'No steps entry for today yet.' }
function renderStepsStats(rows){ let s=0,d=new Date(); while(rows.some(r=>r.date===ymdLocal(d))){s++;d.setDate(d.getDate()-1)} $('#stepsStreak').textContent=`Streak: ${s} ${s===1?'day':'days'}`; const cut=new Date(); cut.setDate(cut.getDate()-6); const iso=ymdLocal(cut); const vals=rows.filter(r=>r.date>=iso && r.steps).map(r=>+r.steps); $('#stepsAvg7').textContent=`7‑day avg: ${vals.length?Math.round(vals.reduce((a,b)=>a+b,0)/vals.length):'—'}` }
function renderStepsTable(rows){ const tb=$('#stepsTable tbody'); tb.innerHTML=''; [...rows].sort((a,b)=>b.date.localeCompare(a.date)).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.date}</td><td>${r.steps||'—'}</td><td>${r.notes? r.notes.replace(/</g,'&lt;'):'—'}</td><td><button class="btn small secondary" data-del-steps="${r.date}">Delete</button></td>`; tb.appendChild(tr); }); tb.onclick=(e)=>{ const d=e.target.getAttribute?.('data-del-steps'); if(!d) return; const left=loadSteps().filter(r=>r.date!==d); saveSteps(left); afterStepsChange(left); toast('Steps entry deleted'); }; }

let stepsRange=7, stepsPts=[];
document.addEventListener('click', (e)=>{ const b=e.target.closest('.stepsRangeBtn'); if(b){ stepsRange=+b.dataset.range; drawStepsChart(); }});
$('#stepsSmooth')?.addEventListener('change', drawStepsChart);

function drawStepsChart(){
  const rows=loadSteps().filter(r=>r.steps);
  const canvas=$('#stepsChart'); if(!canvas) return;
  const {W,H,dpr}=setupCanvas(canvas,260);
  const ctx=canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,W,H);
  stepsPts=[];

  const now=new Date(), start=new Date(); start.setDate(now.getDate()-stepsRange+1); const isoStart=ymdLocal(start);
  const data=rows.filter(r=>r.date>=isoStart).map(r=>({d:r.date,v:+r.steps})).sort((a,b)=>a.d.localeCompare(b.d));
  $('#stepsChartMeta').textContent=data.length?`${data.length} points`:'No data in range';

  const padL=50,padR=12,padT=12,padB=28;
  const cs=getComputedStyle(document.body); const line=cs.getPropertyValue('--line').trim(), acc=cs.getPropertyValue('--acc').trim(), muted=cs.getPropertyValue('--muted').trim();

  ctx.strokeStyle=line; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(padL,padT); ctx.lineTo(padL,H-padB); ctx.lineTo(W-padR,H-padB); ctx.stroke();

  if(!data.length) return;

  const xPos=(i)=> padL + (i/(Math.max(1,data.length-1)))*(W-padL-padR);
  function monthLabel(dstr){ const d=new Date(dstr+'T00:00:00'); return d.toLocaleDateString(undefined,{month:'short',year:stepsRange>365?'2-digit':'numeric'}); }
  let ticks=[];
  if(stepsRange<=14){ for(let i=0;i<data.length;i++){ if(i===0||i===data.length-1||i%2===0){ const d=new Date(data[i].d+'T00:00:00'); const txt=d.toLocaleDateString(undefined,{weekday:'short',day:'numeric'}); ticks.push({i,text:txt}); } } }
  else if(stepsRange<=90){ let last=-1; for(let i=0;i<data.length;i++){ const d=new Date(data[i].d+'T00:00:00'); const nm=d.getMonth()!==last; if(nm||i%5===0||i===data.length-1){ ticks.push({i,text:monthLabel(data[i].d)}); last=d.getMonth(); } } }
  else { let seen={}; for(let i=0;i<data.length;i++){ const d=new Date(data[i].d+'T00:00:00'); const k=`${d.getFullYear()}-${d.getMonth()}`; if(!seen[k]){ seen[k]=true; ticks.push({i,text:d.toLocaleDateString(undefined,{month:'short'})}); } } }
  ctx.fillStyle=muted; ctx.textAlign='center'; ctx.textBaseline='top';
  ticks.forEach(t=>ctx.fillText(t.text, xPos(t.i), H-padB+6));

  const vals=data.map(p=>p.v), yMin=Math.max(0,Math.floor(Math.min(...vals)*0.95)), yMax=Math.ceil(Math.max(...vals)*1.05)||1;
  ctx.textAlign='right'; ctx.textBaseline='middle';
  for(let i=0;i<=5;i++){ const t=i/5; const y=padT+(1-t)*(H-padT-padB); const v=Math.round(yMin+t*(yMax-yMin)); ctx.fillText(v,padL-6,y); ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke(); }

  const k=+($('#stepsSmooth')?.value||1);
  const moving=(arr,k)=>{ if(k<=1) return arr.slice(); const out=[]; let sum=0; for(let i=0;i<arr.length;i++){ sum+=arr[i]; if(i>=k) sum-=arr[i-k]; out.push(i>=k-1? sum/Math.min(k,i+1):arr[i]) } return out };
  const sm=moving(vals,k);
  ctx.strokeStyle=acc; ctx.lineWidth=2; ctx.beginPath();
  sm.forEach((v,i)=>{ const x=xPos(i); const y=padT+(1-((v-yMin)/(yMax-yMin)))*(H-padT-padB); i?ctx.lineTo(x,y):ctx.moveTo(x,y) }); ctx.stroke();

  ctx.fillStyle=acc;
  data.forEach((p,i)=>{ const x=xPos(i); const y=padT+(1-((p.v-yMin)/(yMax-yMin)))*(H-padT-padB); stepsPts.push({x,y,date:p.d}); ctx.beginPath(); ctx.arc(x,y,2.5,0,Math.PI*2); ctx.fill(); });
}

(function bindStepsClicks(){
  const canvas=$('#stepsChart'); if(!canvas) return;
  const getXY=(e)=>{const r=canvas.getBoundingClientRect(); const p=e.touches?e.touches[0]:e; return {x:p.clientX-r.left, y:p.clientY-r.top}};
  const handle=(e)=>{ if(!stepsPts.length) return; const {x,y}=getXY(e); let best=null,d2=1e12; for(const p of stepsPts){ const dx=x-p.x, dy=y-p.y; const dd=dx*dx+dy*dy; if(dd<d2){d2=dd; best=p;} } if(best && d2<=16*16){ const rows=loadSteps(); const r=rows.find(z=>z.date===best.date)||{}; openModal({ title:`Steps • ${best.date}`, html:`<div><b>Steps</b>: ${r.steps||'—'}</div><div style="margin-top:6px"><b>Notes</b>: ${r.notes?String(r.notes).replace(/</g,'&lt;'):'—'}</div>`, onEdit:()=>{ document.querySelector('[data-tab="steps-log"]').click(); $('#stepsDate').value=best.date; $('#stepsCount').value=r.steps||''; $('#stepsNotes').value=r.notes||''; }, onDelete:()=>{ const left=loadSteps().filter(z=>z.date!==best.date); saveSteps(left); afterStepsChange(left); toast('Steps entry deleted'); } }); } };
  function openModal(cfg){ const overlay=$('#modal'); $('#modalTitle').textContent=cfg.title; $('#modalBody').innerHTML=cfg.html; overlay.style.display='flex'; $('#modalClose').onclick=()=>overlay.style.display='none'; $('#modalEdit').onclick=()=>{overlay.style.display='none'; cfg.onEdit?.();}; $('#modalDelete').onclick=()=>{ if(confirm('Delete this entry?')){ cfg.onDelete?.(); overlay.style.display='none'; } }; overlay.onclick=(e)=>{ if(e.target===overlay) overlay.style.display='none'; }; }
  canvas.addEventListener('click',handle); canvas.addEventListener('touchstart',handle,{passive:true});
})();

/* ---------- steps calendar ---------- */
let stepsCalRef=new Date();
function renderStepsCalendar(){
  const rows=loadSteps(); const box=$('#stepsCalendar'); box.innerHTML='';
  $('#stepsCalTitle').textContent=stepsCalRef.toLocaleString(undefined,{month:'long',year:'numeric'});
  const y=stepsCalRef.getFullYear(), m=stepsCalRef.getMonth();
  const first=new Date(y,m,1); const start=new Date(first); const day=(first.getDay()+6)%7; start.setDate(1-day);
  for(let i=0;i<42;i++){
    const d=new Date(start); d.setDate(start.getDate()+i);
    const dISO=ymdLocal(d); const rec=rows.find(r=>r.date===dISO);
    const cell=document.createElement('div'); cell.className='cell'; cell.style.opacity=(d.getMonth()===m)?1:.45;
    cell.innerHTML=`<div class="d">${d.getDate()}</div><div style="margin-top:6px;font-size:13px">${rec?.steps||'—'}</div>`;
    cell.onclick=()=>{ document.querySelector('[data-tab="steps-log"]').click(); $('#stepsDate').value=dISO; $('#stepsCount').value=rec?.steps||''; $('#stepsNotes').value=rec?.notes||''; };
    box.appendChild(cell);
  }
}

/* ---------- month picker wiring ---------- */
function setupMonthPicker(titleSel, inputSel, getRef, setRef){
  const title=$(titleSel), picker=$(inputSel); if(!title||!picker) return;
  function openPicker(){
    const ref=getRef(); const y=ref.getFullYear(); const m=String(ref.getMonth()+1).padStart(2,'0'); picker.value=`${y}-${m}`;
    // iOS allows showPicker inside user gesture; otherwise use .click()
    try{ if(picker.showPicker) picker.showPicker(); else picker.click(); }catch{ picker.click(); }
  }
  title.addEventListener('click', openPicker);
  title.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openPicker(); }});
  title.tabIndex=0; title.setAttribute('role','button');
  picker.addEventListener('change', ()=>{ if(!picker.value) return; const [yy,mm]=picker.value.split('-').map(Number); setRef(new Date(yy,mm-1,1)); });
}

/* ---------- responsive re-draw ---------- */
let resizeTO=null; function redraw(){ clearTimeout(resizeTO); resizeTO=setTimeout(()=>{ try{ drawChart(); drawStepsChart(); }catch(e){} }, 120) }
addEventListener('resize', redraw, {passive:true}); addEventListener('orientationchange', redraw, {passive:true});
</script>

<script>
/* ---------- PWA (v16) ---------- */
if('serviceWorker' in navigator){
  const qs=new URL(location.href).searchParams;
  if(!(qs.has('nosw') || qs.get('nosw')==='1')){
    addEventListener('load', async ()=>{
      try{ const reg=await navigator.serviceWorker.register('./sw.js?v=16'); await reg.update(); }catch(e){}
    });
    let reloaded=false; navigator.serviceWorker.addEventListener('controllerchange', ()=>{ if(reloaded) return; reloaded=true; location.reload(); });
    navigator.serviceWorker.addEventListener('message', (e)=>{ if(e.data?.type==='SW_ACTIVATED') location.reload(); });
  }
}
document.getElementById('installInfo')?.addEventListener('click', ()=>alert('On iPhone: open in Safari → Share → Add to Home Screen.'));
</script>
</body>
</html>
