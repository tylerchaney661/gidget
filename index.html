<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gidget · Hamster Tracker</title>

  <!-- PWA + cache-bust -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0B0F14" />
  <meta name="x-gidget-version" content="2025-08-23-1" />

  <style>
    :root{ --bg:#0B0F14; --card:#0F141A; --line:#1D2A36; --fg:#E9EEF5; --muted:#9FB0C2; --acc:#6EE7B7; --acc-ink:#06291F; --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.35); --ring:0 0 0 2px rgba(110,231,183,.35); }
    @media (prefers-color-scheme: light){
      :root{ --bg:#F6F8FB; --card:#FFFFFF; --line:#E6ECF2; --fg:#0F1720; --muted:#516072; --acc:#0EA5E9; --acc-ink:#00131C; --shadow:0 10px 30px rgba(0,0,0,.08); --ring:0 0 0 2px rgba(14,165,233,.25); }
    }
    *{box-sizing:border-box}
    body{ margin:0; background:radial-gradient(1200px 800px at 80% -200px, rgba(110,231,183,.08), transparent), var(--bg); color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility; }
    header{ position:sticky; top:0; z-index:5; backdrop-filter: blur(8px); background: color-mix(in oklab, var(--bg) 88%, transparent); border-bottom:1px solid var(--line) }
    .nav{ max-width:1000px; margin:0 auto; padding:12px 16px; display:flex; align-items:center; justify-content:space-between }
    .brand{ display:flex; gap:10px; align-items:center }
    .badge{ width:28px; height:28px; border-radius:8px; background:var(--acc); display:grid; place-items:center; color:var(--acc-ink); font-weight:800 }
    .title{ font-weight:800 }
    .muted{ color:var(--muted) }
    .btn{ appearance:none; border:none; border-radius:12px; padding:10px 14px; background:var(--acc); color:var(--acc-ink); font-weight:700; cursor:pointer; box-shadow:var(--shadow) }
    .btn.secondary{ background:transparent; color:var(--fg); border:1px solid var(--line); box-shadow:none; font-weight:600 }
    .btn.small{ padding:8px 10px; font-size:12px }
    main{ max-width:1000px; margin:0 auto; padding:16px }
    .grid{ display:grid; grid-template-columns:1.4fr .9fr; gap:16px }
    @media (max-width: 820px){ .grid{grid-template-columns:1fr} }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow) }
    label{ display:block; font-size:13px; color:var(--muted); margin:8px 0 6px }
    input, select, textarea{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--line); background:var(--bg); color:var(--fg); }
    input:focus, select:focus, textarea:focus{ outline:none; box-shadow: var(--ring) }
    textarea{ min-height:90px; resize:vertical }
    .row{ display:flex; gap:12px; flex-wrap:wrap }
    .col{ flex:1; min-width:200px }
    table{ width:100%; border-collapse:collapse; margin-top:8px }
    th,td{ padding:10px; border-bottom:1px solid var(--line); text-align:left; font-size:14px }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px }
    .tab{ padding:8px 12px; border:1px solid var(--line); border-radius:999px; cursor:pointer; color:var(--muted) }
    .tab.active{ background:var(--acc); color:var(--acc-ink); border-color:transparent; font-weight:800 }
    canvas{ width:100%; height:260px; border:1px solid var(--line); border-radius:12px; background:var(--bg) }
    .calendar{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px }
    .cal-head{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-bottom:6px; color:var(--muted); font-size:12px }
    .cell{ min-height:84px; border:1px solid var(--line); border-radius:12px; padding:8px }
    .cell .d{ font-weight:700; font-size:12px; color:var(--muted) }
    .pill{ display:inline-block; padding:6px 10px; border-radius:9999px; border:1px solid var(--line); font-size:12px; color:var(--muted) }
    .toast{ position:fixed; inset:auto 16px 16px 16px; display:none }
    .toast .inner{ background:var(--card); border:1px solid var(--line); padding:12px 14px; border-radius:14px; box-shadow:var(--shadow) }
    .toast.show{ display:block }

    /* ==== THEME + ACCENT + ANIMATIONS ==== */
    :root { transition: background-color .25s ease, color .25s ease; }
    :root[data-mode="dark"]{
      --bg:#0B0F14; --card:#0F141A; --line:#1D2A36; --fg:#E9EEF5; --muted:#9FB0C2;
    }
    :root[data-mode="light"]{
      --bg:#F6F8FB; --card:#FFFFFF; --line:#E6ECF2; --fg:#0F1720; --muted:#516072;
    }
    .theme-controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-left:8px }
    .theme-controls .group{ display:flex; gap:6px; padding:6px; border:1px solid var(--line); border-radius:12px; background:var(--card) }
    .theme-controls .swatch{ width:22px; height:22px; border-radius:999px; border:1px solid var(--line); cursor:pointer }

    .tabpanel{ opacity:1; transform: translateY(0); }
    .anim-in{ animation: fadeSlide .28s ease both; }
    @keyframes fadeSlide{ from{ opacity:.0; transform: translateY(6px) } to{ opacity:1; transform: translateY(0) } }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand">
        <div class="badge" aria-hidden="true">G</div>
        <div>
          <div class="title">Gidget · Hamster Tracker</div>
          <div class="muted" style="font-size:12px">Log · Trends · Calendar · Offline</div>
        </div>
      </div>
      <div class="right">
        <button id="exportCsv" class="btn secondary">Export CSV</button>
        <label class="btn secondary" style="padding:10px 12px"><input type="file" id="importCsv" accept=".csv" style="display:none">Import CSV</label>
        <button id="installInfo" class="btn">Install</button>

        <!-- Theme + accent + reset -->
        <div id="themeControls" class="theme-controls">
          <div class="group" role="group" aria-label="Theme mode">
            <button id="themeLight" class="btn small secondary" title="Light">Light</button>
            <button id="themeSystem" class="btn small secondary" title="System">System</button>
            <button id="themeDark" class="btn small secondary" title="Dark">Dark</button>
          </div>
          <div class="group" role="group" aria-label="Accent">
            <div class="swatch" data-accent="mint"   title="Mint"   style="background:#6EE7B7"></div>
            <div class="swatch" data-accent="blue"   title="Blue"   style="background:#0EA5E9"></div>
            <div class="swatch" data-accent="violet" title="Violet" style="background:#8b5cf6"></div>
            <div class="swatch" data-accent="amber"  title="Amber"  style="background:#f59e0b"></div>
            <div class="swatch" data-accent="rose"   title="Rose"   style="background:#f43f5e"></div>
          </div>
          <button id="resetData" class="btn small secondary" title="Reset all data">Reset</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="tabs">
      <div class="tab active" data-tab="log">Log</div>
      <div class="tab" data-tab="trends">Trends</div>
      <div class="tab" data-tab="calendar">Calendar</div>
      <div class="tab" data-tab="entries">Entries</div>
    </div>

    <!-- Log -->
    <section class="grid tabpanel" id="panel-log">
      <section class="card">
        <h3>Quick Log</h3>
        <div class="row">
          <div class="col"><label for="date">Date</label><input id="date" type="date"></div>
          <div class="col"><label for="wake">Wake‑Up Time</label><div class="row"><input id="wake" type="time" style="flex:1"><button id="nowBtn" class="btn secondary">Now</button></div></div>
        </div>
        <div class="row">
          <div class="col"><label for="weight">Weight (g)</label><input id="weight" type="number" min="0" step="1" placeholder="Optional"></div>
          <div class="col"><label for="mood">Mood</label><select id="mood"><option value="">—</option><option>Calm</option><option>Curious</option><option>Energetic</option><option>Grumpy</option><option>Sleepy</option></select></div>
        </div>
        <label for="notes">Notes</label><textarea id="notes" placeholder="Behaviour, room temp, cage changes…"></textarea>
        <div class="row" style="margin-top:12px"><button id="save" class="btn">Save Entry</button><button id="clearForm" class="btn secondary">Clear</button></div>
        <div class="muted" id="todayBox" style="margin-top:8px">—</div>
        <div class="row" style="margin-top:8px"><span class="pill" id="streak">Streak: 0 days</span><span class="pill" id="avg7">7‑day avg: —</span></div>
      </section>

      <section class="card">
        <h3>Filter</h3>
        <div class="row">
          <div class="col"><label for="filterFrom">From</label><input id="filterFrom" type="date"></div>
          <div class="col"><label for="filterTo">To</label><input id="filterTo" type="date"></div>
        </div>
        <div class="row" style="margin-top:10px"><button id="applyFilter" class="btn secondary">Apply</button><button id="resetFilter" class="btn secondary">Reset</button></div>
      </section>
    </section>

    <!-- Trends -->
    <section class="card tabpanel" id="panel-trends" hidden>
      <div class="row" style="align-items:center; justify-content:space-between">
        <div class="row">
          <button class="btn small secondary rangeBtn" data-range="7">Week</button>
          <button class="btn small secondary rangeBtn" data-range="30">Month</button>
          <button class="btn small secondary rangeBtn" data-range="365">Year</button>
        </div>
        <div class="row">
          <label for="smooth" class="muted" style="margin:0">Smoothing</label>
          <select id="smooth"><option value="1">None</option><option value="3">3‑day</option><option value="7">7‑day</option></select>
        </div>
      </div>
      <canvas id="chart" width="900" height="260" style="margin-top:10px"></canvas>
      <div class="muted" id="chartMeta" style="margin-top:6px">—</div>
    </section>

    <!-- Calendar -->
    <section class="card tabpanel" id="panel-calendar" hidden>
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="row"><button id="prevMonth" class="btn small secondary">‹</button><button id="todayMonth" class="btn small secondary">Today</button><button id="nextMonth" class="btn small secondary">›</button></div>
        <div class="title" id="calTitle">—</div>
      </div>
      <div class="cal-head" style="margin-top:8px"><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div></div>
      <div class="calendar" id="calendar"></div>
    </section>

    <!-- Entries -->
    <section class="card tabpanel" id="panel-entries" hidden>
      <h3>Entries</h3>
      <table id="table"><thead><tr><th>Date</th><th>Wake‑Up</th><th>Weight</th><th>Mood</th><th>Food</th><th>Sand</th><th>Notes</th><th></th></tr></thead><tbody></tbody></table>
    </section>
  </main>

  <div class="toast" id="toast"><div class="inner" id="toastText">Saved</div></div>

<script>
/* Local date helper to avoid UTC off-by-one */
function ymdLocal(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }

/* ==== THEME STATE ==== */
const THEME_MODE_KEY = 'gidget.theme.mode';   // 'system' | 'light' | 'dark'
const THEME_ACCENT_KEY = 'gidget.theme.accent'; // 'mint' | 'blue' | 'violet' | 'amber' | 'rose'
const ACCENTS = { mint:'#6EE7B7', blue:'#0EA5E9', violet:'#8b5cf6', amber:'#f59e0b', rose:'#f43f5e' };

function applyTheme(mode, accent){
  const root = document.documentElement;
  if(mode==='light' || mode==='dark'){ root.setAttribute('data-mode', mode); }
  else{ root.removeAttribute('data-mode'); }
  const hex = ACCENTS[accent] || ACCENTS.mint;
  root.style.setProperty('--acc', hex);
}

function initThemeControls(){
  const savedMode = localStorage.getItem(THEME_MODE_KEY) || 'system';
  const savedAcc = localStorage.getItem(THEME_ACCENT_KEY) || 'mint';
  applyTheme(savedMode, savedAcc);
  const bL=$('#themeLight'), bS=$('#themeSystem'), bD=$('#themeDark');
  if(bL) bL.onclick=()=>{ localStorage.setItem(THEME_MODE_KEY,'light'); applyTheme('light', localStorage.getItem(THEME_ACCENT_KEY)||'mint'); };
  if(bS) bS.onclick=()=>{ localStorage.setItem(THEME_MODE_KEY,'system'); applyTheme('system', localStorage.getItem(THEME_ACCENT_KEY)||'mint'); };
  if(bD) bD.onclick=()=>{ localStorage.setItem(THEME_MODE_KEY,'dark'); applyTheme('dark', localStorage.getItem(THEME_ACCENT_KEY)||'mint'); };
  $$('#themeControls .swatch').forEach(el=>{
    el.addEventListener('click', ()=>{
      const a = el.getAttribute('data-accent');
      localStorage.setItem(THEME_ACCENT_KEY, a);
      applyTheme(localStorage.getItem(THEME_MODE_KEY)||'system', a);
    });
  });
}

const KEY='gidget_site_v1';
const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>[...r.querySelectorAll(s)];
const todayISO=ymdLocal(new Date());
function load(){ try{return JSON.parse(localStorage.getItem(KEY))||[]}catch(e){return[]} }
function save(rows){ localStorage.setItem(KEY, JSON.stringify(rows)) }
function toast(msg){ $('#toastText').textContent=msg; $('#toast').classList.add('show'); setTimeout(()=>$('#toast').classList.remove('show'),1400) }
function toMin(t){ if(!t) return null; const [H,M]=t.split(':').map(Number); return H*60+M } function fromMin(m){ const H=String(Math.floor(m/60)).padStart(2,'0'); const M=String(m%60).padStart(2,'0'); return `${H}:${M}` }

/* Tabs */
$$('.tab').forEach(tab=> tab.addEventListener('click', ()=>{
  $$('.tab').forEach(t=>t.classList.remove('active'));
  tab.classList.add('active');
  const id=tab.dataset.tab;
  $$('.tabpanel').forEach(p=>p.hidden=true);
  const panel = $('#panel-'+id);
  panel.hidden = false;
  panel.classList.add('anim-in');
  panel.addEventListener('animationend', ()=> panel.classList.remove('anim-in'), {once:true});
  if(id==='trends') drawChart(); if(id==='calendar') renderCalendar(); if(id==='entries') renderTable(load());
}));

/* Form */
const dateEl=$('#date'), wakeEl=$('#wake'), weightEl=$('#weight'), moodEl=$('#mood'), notesEl=$('#notes'); dateEl.value=todayISO;
$('#nowBtn').onclick=()=>{ const n=new Date(); wakeEl.value=`${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}` }
$('#save').onclick=()=>{ const row={date:dateEl.value||todayISO,wake:wakeEl.value||'',weight:weightEl.value||'',mood:moodEl.value||'',notes:notesEl.value||''}; const rows=load().filter(r=>r.date!==row.date); rows.push(row); rows.sort((a,b)=>a.date.localeCompare(b.date)); save(rows); renderToday(rows); renderStats(rows); renderTable(rows); drawChart(); renderCalendar(); toast('Saved') }
$('#clearForm').onclick=()=>{ dateEl.value=todayISO; wakeEl.value=''; weightEl.value=''; moodEl.value=''; notesEl.value='' }

/* Filter */
$('#applyFilter').onclick=()=> renderTable(load());
$('#resetFilter').onclick=()=>{ $('#filterFrom').value=''; $('#filterTo').value=''; renderTable(load()) }

/* Stats */
function avg(rows,days){ const cut=new Date(); cut.setDate(cut.getDate()-days+1); const iso=ymdLocal(cut); const ts=rows.filter(r=>r.date>=iso && r.wake).map(r=>toMin(r.wake)); if(!ts.length) return null; return fromMin(Math.round(ts.reduce((a,b)=>a+b,0)/ts.length)) }
function renderToday(rows){ const t=rows.find(r=>r.date===todayISO); $('#todayBox').textContent=t?`Today ${t.date}: wake ${t.wake||'—'} · weight ${t.weight||'—'}g · mood ${t.mood||'—'}`:'No entry for today yet.' }
function renderStats(rows){ let s=0, d=new Date(); while(rows.some(r=>r.date===ymdLocal(d))){ s++; d.setDate(d.getDate()-1) } $('#streak').textContent=`Streak: ${s} ${s===1?'day':'days'}`; $('#avg7').textContent=`7‑day avg: ${avg(rows,7)||'—'}` }

/* Table */
function renderTable(rows){ const tb=$('#table tbody'); if(!tb) return; tb.innerHTML=''; const f1=$('#filterFrom')?.value||'', f2=$('#filterTo')?.value||''; const filtered=rows.filter(r=>(!f1||r.date>=f1)&&(!f2||r.date<=f2)).sort((a,b)=>b.date.localeCompare(a.date)); for(const r of filtered){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.date}</td><td>${r.wake||'—'}</td><td>${r.weight||'—'}</td><td>${r.mood||'—'}</td><td>${r.food||'—'}</td><td>${r.sand||'—'}</td><td>${r.notes? r.notes.replace(/</g,'&lt;'):'—'}</td><td><button class="btn secondary small" data-date="${r.date}">Delete</button></td>`; tb.appendChild(tr) } $$('button[data-date]',tb).forEach(b=> b.addEventListener('click', e=>{ const d=e.target.getAttribute('data-date'); const left=load().filter(r=>r.date!==d); save(left); renderTable(left); drawChart(); renderCalendar(); toast('Entry deleted') })) }

/* Trends */
let rangeDays=7; $('#smooth')?.addEventListener('change', drawChart); $$('.rangeBtn').forEach(b=> b.addEventListener('click', ()=>{ rangeDays=+b.dataset.range; drawChart() }));
function movingAvg(arr,k){ if(k<=1) return arr.slice(); const out=[]; let sum=0; for(let i=0;i<arr.length;i++){ sum+=arr[i]; if(i>=k) sum-=arr[i-k]; out.push(i>=k-1?sum/Math.min(k,i+1):arr[i]) } return out }
function drawChart(){ const rows=load().filter(r=>r.wake); const canvas=$('#chart'); if(!canvas) return; const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width, canvas.height); const now=new Date(); const start=new Date(); start.setDate(now.getDate()-rangeDays+1); const isoStart=ymdLocal(start); const data=rows.filter(r=>r.date>=isoStart).map(r=>({d:r.date,m:toMin(r.wake)})).sort((a,b)=>a.d.localeCompare(b.d)); $('#chartMeta').textContent=data.length?`${data.length} points`:'No data in range'; const padL=50, padR=12, padT=12, padB=24, W=canvas.width, H=canvas.height; const styles=getComputedStyle(document.body); const line=styles.getPropertyValue('--line'); const acc=styles.getPropertyValue('--acc'); const muted=styles.getPropertyValue('--muted'); ctx.strokeStyle=line; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(padL,padT); ctx.lineTo(padL,H-padB); ctx.lineTo(W-padR,H-padB); ctx.stroke(); function yMap(mins){ let v=mins; if(v<900) v+=1440; const min=900, max=1800; const t=(v-min)/(max-min); return padT+(1-t)*(H-padT-padB) } const ticks=[18*60,21*60,0,3*60]; ctx.fillStyle=muted; ctx.textAlign='right'; ctx.textBaseline='middle'; ctx.font='12px system-ui'; ticks.forEach(t=>{ const y=yMap(t); ctx.fillText(fromMin((t+1440)%1440), padL-6, y); ctx.strokeStyle=line; ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke() }); if(!data.length) return; const xPos=(i)=> padL + (i/(Math.max(1,data.length-1)))*(W-padL-padR); ctx.fillStyle=acc; data.forEach((pt,i)=>{ const x=xPos(i), y=yMap(pt.m); ctx.beginPath(); ctx.arc(x,y,2.5,0,Math.PI*2); ctx.fill() }); const k=+($('#smooth')?.value||1); const vals=data.map(d=>{ let v=d.m; if(v<900) v+=1440; return v }); const sm=movingAvg(vals,k); ctx.strokeStyle=acc; ctx.lineWidth=2; ctx.beginPath(); sm.forEach((v,i)=>{ const x=xPos(i); const y=padT + (1-((v-900)/(1800-900)))*(H-padT-padB); i?ctx.lineTo(x,y):ctx.moveTo(x,y) }); ctx.stroke() }

/* Calendar */
let calRef=new Date();
function ymd(d){ return ymdLocal(d) }
function renderCalendar(){ const rows=load(); const box=$('#calendar'); if(!box) return; box.innerHTML=''; const y=calRef.getFullYear(), m=calRef.getMonth(); $('#calTitle').textContent=calRef.toLocaleString(undefined,{month:'long', year:'numeric'}); const first=new Date(y,m,1); const start=new Date(first); const day=(first.getDay()+6)%7; start.setDate(1-day); for(let i=0;i<42;i++){ const d=new Date(start); d.setDate(start.getDate()+i); const cell=document.createElement('div'); cell.className='cell'; cell.style.opacity = (d.getMonth()===m)?1:.45; const dISO=ymd(d); const rec=rows.find(r=>r.date===dISO); cell.innerHTML=`<div class="d">${d.getDate()}</div><div style="margin-top:6px;font-size:13px">${rec?.wake||'—'}</div>`; cell.addEventListener('click',()=>{ $('#date').value=dISO; $('#wake').value=rec?.wake||''; $('#weight').value=rec?.weight||''; $('#mood').value=rec?.mood||''; $('#notes').value=rec?.notes||''; $$('.tab').forEach(t=>t.classList.remove('active')); $('[data-tab="log"]').classList.add('active'); $$('.tabpanel').forEach(p=>p.hidden=true); const pl=$('#panel-log'); pl.hidden=false; pl.classList.add('anim-in'); pl.addEventListener('animationend', ()=> pl.classList.remove('anim-in'), {once:true}); }); box.appendChild(cell) } }
$('#prevMonth')?.addEventListener('click', ()=>{ calRef.setMonth(calRef.getMonth()-1); renderCalendar() })
$('#nextMonth')?.addEventListener('click', ()=>{ calRef.setMonth(calRef.getMonth()+1); renderCalendar() })
$('#todayMonth')?.addEventListener('click', ()=>{ calRef=new Date(); renderCalendar() })

/* CSV */
$('#exportCsv').onclick=()=>{ const rows=load(); const header='Date,Wake-Up Time,Weight (g),Mood,Food,Sand,Notes\n'; const csv=header+rows.map(r=>[r.date,r.wake,r.weight,r.mood,r.food,r.sand,JSON.stringify(r.notes||'').slice(1,-1)].join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='gidget_data.csv'; a.click() }
$('#importCsv').addEventListener('change', async (e)=>{ const file=e.target.files[0]; if(!file) return; const text=await file.text(); const lines=text.trim().split(/\r?\n/); lines.shift(); const rows=[]; for(const ln of lines){ const p=ln.split(','); rows.push({date:p[0],wake:p[1]||'',weight:p[2]||'',mood:p[3]||'',food:p[4]||'',sand:p[5]||'',notes:p.slice(6).join(',')||''}) } save(rows); renderToday(rows); renderStats(rows); renderTable(rows); drawChart(); renderCalendar(); toast('Imported CSV') })

/* Reset all data */
$('#resetData')?.addEventListener('click', ()=>{
  if(confirm('Reset all Gidget entries on this device? This cannot be undone.')){
    localStorage.removeItem(KEY);
    const rows=[]; renderToday(rows); renderStats(rows); renderTable(rows); drawChart(); renderCalendar();
    toast('All data cleared');
  }
});

/* Boot: theme + app + SW message hook */
document.addEventListener('DOMContentLoaded', ()=>{
  initThemeControls();
  const rows=load(); renderToday(rows); renderStats(rows); renderTable(rows); drawChart(); renderCalendar();
});

// Service worker registration + message listener for hard reload on activate
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
  navigator.serviceWorker.addEventListener('message', (e) => {
    if (e.data?.type === 'SW_ACTIVATED') location.reload();
  });
}

/* Install help */
$('#installInfo').onclick=()=> alert('On iPhone: open this URL in Safari → Share → Add to Home Screen.');
</script>
</body>
</html>